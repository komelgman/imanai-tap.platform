name: Publish Parent POM
on:
  workflow_call:
    inputs:
      parent_pom_changed:
        required: true
        type: boolean

jobs:
  publish-parent:
    if: inputs.parent_pom_changed == true
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'

      - uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-parent-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            maven-parent-

      - name: Extract POM info
        id: pom-info
        run: |
          GROUP_ID=$(mvn help:evaluate -Dexpression=project.groupId -q -DforceStdout -f pom.xml)
          ARTIFACT_ID=$(mvn help:evaluate -Dexpression=project.artifactId -q -DforceStdout -f pom.xml)
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout -f pom.xml)

      - name: Deploy parent POM to GitHub Packages
        env:
          MAVEN_USERNAME: ${{ github.actor }}
          MAVEN_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Deploying \`${{ steps.pom-info.outputs.group_id }}:${{ steps.pom-info.outputs.artifact_id }}:${{ steps.pom-info.outputs.version }}\`"
          mvn -B clean deploy -N \
            -f pom.xml \
            -s .github/workflows/settings.xml \
            -DskipTests \
            -Dmaven.install.skip=true

      - name: Generate summary
        run: |
          echo "## Parent POM Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.pom-info.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifact**: \`${{ steps.pom-info.outputs.group_id }}:${{ steps.pom-info.outputs.artifact_id }}:${{ steps.pom-info.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: [GitHub Packages](https://github.com/${{ github.repository }}/packages)" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: [\`${GITHUB_SHA:0:7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
